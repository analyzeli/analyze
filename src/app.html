<div id="app">
  <div class="source-bar">
    <!-- LOGO -->
    <div class="logo-block">
      <img class="logo" src="images/logo.png"/>
    </div>

    <!-- SOURCE SELECTION -->
    <div class="source-tabs" v-if="sources.length">
      <div
        v-for="(source, i) in sources"
        :key="source.name + i"
        :class="{'source-tab': true, 'active-tab': (activeSource === i)}"
        >
        <md-button class="md-dense" v-on:click.native="showSource(i)">
          {{ (source.name.length > 13) ? source.name.substring(0, 13) + '...' : source.name }}
        </md-button>
        <md-button v-on:click.native="removeSource(i)" class="md-icon-button md-dense">
          <md-icon>clear</md-icon>
        </md-button>
      </div>
    </div>

    <md-button id="open-button" class="md-primary md-raised" v-on:click.native="open">
      Add source
    </md-button>

    <div class="info-block">
      Everything is processed locally on your machine.
    </div>
  </div>

  <div class="transform-bar" v-if="sources.length">
    <md-card>
      <md-card-header>
        <div class="md-title" style="font-weight: 600;">
          {{ sources[activeSource].name }}
        </div>
        <div class="md-subhead" v-if="sources[activeSource].size">
          Source size: {{ (sources[activeSource].size / (1024 ** 2)).toFixed(2) }}Mb<br>
          Modified: {{ sources[activeSource].file.lastModifiedDate.toUTCString() }}<br>
          Type: {{ sources[activeSource].type.toUpperCase() }}
        </div>
        <div class="md-subhead" v-if="sources[activeSource].url">
          Source URL: {{ sources[activeSource].url }}<br>
          Type: {{ sources[activeSource].type.toUpperCase() }}
        </div>

      </md-card-header>
    </md-card>

    <!-- 
      Select an active source 
    <md-button-toggle class="md-raised md-primary" md-single v-if="sources.length">
      <md-button 
        v-for="(source, i) in sources"
        v-on:click.native="showSource(i)"
        :key="source.name + i"
        :class="{'md-toggle': (activeSource == i)}"
      > {{ source.name }} </md-button>
    </md-button-toggle>
    -->

    <!-- Generate sidebar for each active source (source) -->
    <md-list v-for="source in [sources[activeSource]]" :class="{hidden: source.loading}">
      <!-- FILTER/SEARCH -->
      <md-list-item :md-expand-multiple="true">
        <md-icon class="md-primary">filter_list</md-icon>
        <div class="md-subheading">Filter (Search)</div>
        <md-list-expand>
          <md-card>
            <md-card-content>
              <!-- Add new filter -->
              <md-button v-on:click.native="source.addFilter()">
                <md-icon>add</md-icon>Add new filter
              </md-button>

              <!-- Filter block -->
              <md-card class="item-card md-primary" v-for="(filter, i) in source.pipeline.filters" :key="source.name + i">
                <!-- Filter name and remove button -->
                <md-card-header>
                  <md-card-header-text>
                    <div class="md-subhead"> {{ (filter.range) ?  'Range: ' + filter.from + ' -> ' + filter.to : 'Search: ' + filter.value }} </div>
                  </md-card-header-text>
                  <md-menu md-size="4" md-direction="bottom left">
                    <md-button class="md-icon-button" md-menu-trigger>
                      <md-icon>more_vert</md-icon>
                    </md-button>
                    <md-menu-content>
                      <md-menu-item v-on:click.native="source.removeFilter(i)">
                        <span>Remove filter</span>
                        <md-icon>delete</md-icon>
                      </md-menu-item>
                    </md-menu-content>
                  </md-menu>
                </md-card-header>

                <!-- Filter params -->
                <md-card-content>
                  <md-switch v-model="source.pipeline.filters[i].range" class="md-warn">Range</md-switch>
                  <md-input-container v-if="!source.pipeline.filters[i].range">
                    <label>Search string</label>
                    <md-input v-model="source.pipeline.filters[i].value"></md-input>
                  </md-input-container>
                  <md-input-container v-if="source.pipeline.filters[i].range">
                    <label>From: </label>
                    <md-input type="number" v-model="source.pipeline.filters[i].from"></md-input>
                  </md-input-container>
                  <md-input-container v-if="source.pipeline.filters[i].range">
                    <label>To: </label>
                    <md-input type="number" v-model="source.pipeline.filters[i].to"></md-input>
                  </md-input-container>
                  <md-input-container>
                    <label for="search-column">Search in columns</label>
                    <md-select
                      name="search-column"
                      v-model="source.pipeline.filters[i].column">
                      <md-option v-for="column in source.columns" :value="column" :key="column">{{ column }}</md-option>
                    </md-select>
                  </md-input-container>
                  <md-checkbox name="casesensitive" v-if="!source.pipeline.filters[i].range" v-model="source.pipeline.filters[i].casesensitive" class="md-primary">Case sensitive</md-checkbox>
                  <md-checkbox name="strict" v-if="!source.pipeline.filters[i].range" v-model="source.pipeline.filters[i].strict" class="md-primary">Strict search</md-checkbox>
                </md-card-content>
              </md-card> 
              <!-- *Filter block-->

            </md-card-content>
          </md-card>
        </md-list-expand>
      </md-list-item>
      <!-- *FILTER -->

      <!-- RESTRUCTURE -->
      <md-list-item :md-expand-multiple="true">
        <md-icon class="md-primary">device_hub</md-icon>
        <div class="md-subheading">Structure (Columns)</div>
        <md-list-expand>
          <md-card>
            <md-card-content>
              <md-checkbox name="columns-showall" v-model="source.pipeline.restructure.showAllColumns" class="md-primary">Keep all columns</md-checkbox>
              
              <div
                v-if="!source.pipeline.restructure.showAllColumns"
                v-for="column in source.columns"
              >
                <input 
                  type="checkbox"
                  :id="column + i"
                  :name="column + i"
                  :value="column"
                  :key="column"
                  v-model="source.pipeline.restructure.newColumns"
                />
                <label :for="column + i">{{ column }}</label>
              </div>

              <!--
              <md-input-container v-if="!source.pipeline.restructure.showAllColumns">
                <label for="columns">Columns:</label>
                <md-select id="columns" name="columns" multiple v-model="source.pipeline.restructure.newColumns">
                  <md-option
                    v-for="(column, i) in source.columns"
                    :value="column"
                    :key="column + i"
                  >{{ column }}</md-option>
                </md-select>
              </md-input-container>
              -->

            </md-card-content>
          </md-card>
        </md-list-expand>
      </md-list-item>

      <!-- PLOT STREAM -->
      <md-list-item :md-expand-multiple="true" :class="{hidden: isStreamLoadingNow}">
          <md-icon class="md-primary">bubble_chart</md-icon>
          <div class="md-subheading">Plot stream</div>
          <md-list-expand>
            <md-card>
              <md-card-content>
                <md-checkbox id="plot-display" name="plot-display" v-model="plotStream.display" class="md-primary">Visualize plot</md-checkbox>
                <div v-if="plotStream.display">
                  <h4>X axis</h4>
                  <md-input-container>
                    <label for="x-column">Select column for X</label>
                    <md-select name="x-column" id="x-column" v-model="plotStream.data.xColumn">
                      <md-option v-for="column in columns" :value="column" :key="column">{{ column }}</md-option>
                    </md-select>
                  </md-input-container>

                  <md-input-container md-inline>
                      <md-input name="x-min" id="x-min" type="number" placeholder="X-min" v-model="plotStream.data.xRange.min"></md-input>
                      <md-input name="x-max" id="x-max" type="number" placeholder="X-max" v-model="plotStream.data.xRange.max"></md-input>
                  </md-input-container>

                  <h4>Y axis</h4>

                  <md-input-container>
                    <label for="y-column">Select column for Y</label>
                    <md-select name="y-column" id="y-column" v-model="plotStream.data.yColumn">
                      <md-option v-for="column in columns" :value="column" :key="column">{{ column }}</md-option>
                    </md-select>
                  </md-input-container>

                  <md-input-container md-inline>
                      <md-input name="y-min" id="y-min" type="number" placeholder="Y-min" v-model="plotStream.data.yRange.min"></md-input>
                      <md-input name="y-max" id="y-max" type="number" placeholder="Y-max" v-model="plotStream.data.yRange.max"></md-input>
                  </md-input-container>
                </div>
              </md-card-content>
            </md-card>
          </md-list-expand>
      </md-list-item>

      <!-- ANALYSIS -->
      <md-list-item :md-expand-multiple="true" :class="{hidden: isStreamLoadingNow}">
        <md-icon class="md-primary">functions</md-icon>
        <div class="md-subheading">Analysis</div>
        <md-list-expand>
          <md-card>
            <md-card-content>
              <!-- Add new stat menu -->
              <md-menu md-direction="bottom left" md-size="4">
                <md-button md-menu-trigger>
                  <md-icon>add</md-icon>
                  Add function
                </md-button>
                <md-menu-content>
                  <md-menu-item v-for="type in statTypes" :key="type" v-on:click.native="addStat(type)">
                    <span> {{ type }}</span>
                    <md-icon>add_circle_outline</md-icon>
                  </md-menu-item>
                </md-menu-content>
              </md-menu>

              <!-- Stat blocks -->
              <md-card class="stat-card md-primary" v-for="(stat, index) in stats" :key="stat.name">
                <md-card-header>
                  <md-card-header-text>
                    <div class="md-subhead"> {{ stat.name }} </div>
                  </md-card-header-text>
                  <md-menu md-size="4" md-direction="bottom left">
                    <md-button class="md-icon-button" md-menu-trigger>
                      <md-icon>more_vert</md-icon>
                    </md-button>
                    <md-menu-content>
                      <md-menu-item v-on:click.native="removeStat(index)">
                        <span>Remove</span>
                        <md-icon>delete</md-icon>
                      </md-menu-item>
                    </md-menu-content>
                  </md-menu>
                </md-card-header>
                <md-card-content>
                  <md-input-container v-for="(prop, key) in stat.props" :key="key">
                    <label>{{ key }}</label>
                    <md-select v-model="prop.value" v-if="prop.type === 'Column'">
                      <md-option 
                        v-for="column in columns" 
                        :value="column" 
                        :key="column"
                      >{{ column }}</md-option>
                    </md-select>
                    <md-input
                      type="number"
                      v-model="prop.value" 
                      v-if="prop.type === 'Number'" 
                    ></md-input>
                  </md-input-container>
                </md-card-content>
              </md-card>
            </md-card-content>
          </md-card>
        </md-list-expand>
      </md-list-item>

      <!-- CHARTS -->
      <md-list-item :md-expand-multiple="true" :class="{hidden: isStreamLoadingNow}">
        <md-icon class="md-primary">equalizer</md-icon>
        <div class="md-subheading">Charts</div>
        <md-list-expand>
          <md-card>
          <md-card-content>
            <!-- Add new chart menu -->
            <md-menu md-direction="bottom left" md-size="4">
              <md-button class="md-icon-button" md-menu-trigger>
                <md-icon>add</md-icon>
              </md-button>
              <md-menu-content>
                <md-menu-item v-for="type in chartTypes" :key="type" v-on:click.native="addChart(type)">
                  <span> {{ type }}</span>
                  <md-icon>add_circle_outline</md-icon>
                </md-menu-item>
              </md-menu-content>
            </md-menu>

            <!-- Chart blocks -->
            <md-card class="stat-card md-primary" v-for="(chart, index) in charts" :key="chart.name">
              <md-card-header>
                <md-card-header-text>
                  <div class="md-subhead"> {{ chart.name }} </div>
                </md-card-header-text>
                <md-menu md-size="4" md-direction="bottom left">
                  <md-button class="md-icon-button" md-menu-trigger>
                    <md-icon>more_vert</md-icon>
                  </md-button>
                  <md-menu-content>
                    <md-menu-item v-on:click.native="removeChart(index)">
                      <span>Remove</span>
                      <md-icon>delete</md-icon>
                    </md-menu-item>
                  </md-menu-content>
                </md-menu>
              </md-card-header>
              <md-card-content>
                <!-- Select collection -->
                <md-input-container>
                  <label>Select collection</label>
                  <md-select v-model="chart.inputCollection">
                    <md-option v-for="(collection, collectionName) in collections" :key="collectionName" :value="collectionName">{{ collectionName }}</md-option>
                  </md-select>
                </md-input-container>
                <!-- Select column of labels and values -->
                <div v-if="chart.inputCollection">
                  <md-input-container>
                    <label>Select labels</label>
                    <md-select v-model="chart.labelColumn">
                      <md-option v-for="(column, columnName) in collections[chart.inputCollection].records" :key="columnName" :value="columnName">{{ columnName }}</md-option>
                    </md-select>
                  </md-input-container>
                  <md-input-container>
                    <label>Select values</label>
                    <md-select v-model="chart.inputColumn">
                      <md-option v-for="(column, columnName) in collections[chart.inputCollection].records" :key="columnName" :value="columnName">{{ columnName }}</md-option>
                    </md-select>
                  </md-input-container>
                </div>
              </md-card-content>
            </md-card>

          </md-card-content>
          </md-card>
        </md-list-expand>
      </md-list-item>

      <!-- TABLE -->
      <md-list-item :md-expand-multiple="true" :class="{hidden: isStreamLoadingNow}">
        <md-icon class="md-primary">view_list</md-icon>
        <div class="md-subheading">Table (slow)</div>
        <md-list-expand>
          <md-card>
            <md-card-content>
              <md-checkbox v-for="(collection, collectionName) in collections" v-model="collection.display" :key="collectionName" :name="collectionName + '-display'" class="md-primary">Display {{ collectionName }} collection</md-checkbox>
            </md-card-content>
          </md-card>
        </md-list-expand>
      </md-list-item>

      <!-- OUTPUT -->
      <md-list-item :md-expand-multiple="true" :class="{hidden: isStreamLoadingNow}">
        <md-icon class="md-primary">file_download</md-icon>
        <div class="md-subheading">Save</div>
        <md-list-expand>
          <md-card>
            <md-card-content>
              <md-checkbox v-for="(collection, collectionName) in collections" v-model="collection.save" :key="collectionName" :name="collectionName + '-save'" class="md-primary">Save {{ collectionName }} collection</md-checkbox>
            </md-card-content>
          </md-card>
        </md-list-expand>
      </md-list-item>

    </md-list>
    <div v-if="sources[activeSource]" style="margin: 10px 16px;">
      <md-card>
        <md-card-header>
          <div class="md-title">
            Processed: {{ sources[activeSource].progress }}%
          </div>
          <div class="md-subhead">
            Total: {{ (sources[activeSource].processed / (1024 ** 2)).toFixed(2)}}Mb of {{ (sources[activeSource].size / (1024 ** 2)).toFixed(2) }}Mb<br>
          </div>
        </md-card-header>
        <md-button v-if="!sources[activeSource].loading" class="md-raised md-primary control-button" v-on:click.native="process(sources[activeSource])"><md-icon>play_arrow</md-icon> Run</md-button>
        <md-button v-if="sources[activeSource].loading" v-on:click.native="stop(sources[activeSource])" class="md-raised md-accent control-button"><md-icon>stop</md-icon> Stop</md-button>
      </md-card>
    </div>
  </div>

  <!--
  ************************
  CONTENT WITH COLLECTIONS
  ************************
  -->
  <div class="content" v-bind:style="{marginLeft: (sources.length) ? '33%' : '11%'}">
    <!-- COLLECTION TABS -->
    <div 
      class="tabs"
      v-if="collections.length">
      <div
        v-for="(collection, i) in collections"
        :key="collection.name + i"
        :class="{'tab': true, 'active-tab': (activeCollection === i)}"
        >
        <md-button
          v-on:click.native="showCollection(i)"
        >
          {{ collection.name }}
        </md-button>
        <md-button 
          v-on:click.native="removeCollection(i)"
          class="md-icon-button md-dense"
        >
          <md-icon>clear</md-icon>
        </md-button>
      </div>
    </div>

    <!-- Generate link-->
    <md-button v-if="url.length" class="md-fab md-primary md-fab-top-right" id="fab" @click.native="generateLink()">
      <md-icon>share</md-icon>
      <md-tooltip md-direction="bottom">Generate link</md-tooltip>
    </md-button>
    <p v-if="total"> Total: {{ total }} </p>
    <md-chips v-model="searchArr" v-if="searchArr.length" class="search-chips" md-static>
      <template scope="chip">{{ chip.value }}</template>
    </md-chips>

    <div class="plotStream" v-if="plotStream.display">
      <canvas id="canvas" v-bind:width="plotStream.xSize" v-bind:height="plotStream.ySize"></canvas>
    </div>

    <div v-if="collections.length && (collections[activeCollection].display || collections[activeCollection].save)">

      <!-- Loader -->
      <div
        id="loading"
        v-bind:style="{width: collections[activeCollection].source.progress + '%'}" 
        v-if="collections[activeCollection].source.loading"
      ></div>

      <!-- Collection name-->
      <md-input-container class="collection-name" md-clearable>
        <label>Collection name</label>
        <md-input v-model="collections[activeCollection].name"></md-input>
      </md-input-container>

      <!-- DASHBOARD -->
      <div class="dashboard" v-if="!collections[activeCollection].preview">
        <md-card class="card">
          <md-card-header>
            <md-card-header-text>
              <div class="md-title">{{ collections[activeCollection].length }} </div>
              <div class="md-subhead">Number of records loaded...</div>
            </md-card-header-text>
          </md-card-header>
          <md-card-actions v-if="!collections[activeCollection].loading">
            <md-button class="md-dense" v-if="collections[activeCollection].length && collections[activeCollection].save" v-on:click.native="save(activeCollection, 'csv')"><md-icon class="primary-color">file_download</md-icon> Save CSV</md-button>
            <md-button class="md-dense" v-if="collections[activeCollection].length && collections[activeCollection].save" v-on:click.native="save(activeCollection, 'json')"><md-icon class="primary-color">file_download</md-icon> Save JSON</md-button>
          </md-card-actions>
        </md-card>
      </div>

      <!--
      <p id="processed" v-if="fileSize">Processed: <b>{{ (100*processed/fileSize).toFixed(0) }}%</b> ({{ (processed/1024).toFixed(1) }}K of {{ (fileSize/1024).toFixed(1) }}K)</p>
      <h3>Collection: <strong class="primary-color">{{ collections[activeCollection].name }}</strong></h3>
      <chartist
          v-for="chart in charts"
          :key="chart.name"
          v-if="(collections[activeCollection]collection.length > 1) && (chart.inputCollection == collectionName) && (chart.type != 'Pie')"
          ratio="ct-major-second"
          :type="chart.type"
          :data="{labels:collection.records[chart.labelColumn], series:[collection.records[chart.inputColumn]]}"
          :options="chartOptions"
          style="max-width: 400px" >
      </chartist>
      <chartist
          v-for="chart in charts"
          :key="chart.name"
          v-if="(collection.length > 1) && (chart.inputCollection == collectionName) && (chart.type == 'Pie')"
          ratio="ct-major-second"
          :type="chart.type"
          :data="{labels:collection.records[chart.labelColumn], series:collection.records[chart.inputColumn]}"
          :options="chartOptions"
          style="max-width: 400px" >
        </chartist>
      -->
      <table v-if="collections[activeCollection].display">
        <thead>
          <tr>
            <th></th>
            <th v-for="(columnValues, columnName) in collections[activeCollection].records">
              {{ columnName }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="index in collections[activeCollection].length" :key="index">
            <td style="color:#AAA; font-size:11px; border: 0; text-align: right; padding-right: 10px;"> {{ index }} </td>
            <td v-for="(columnValues,columnName) in collections[activeCollection].records">
              {{ columnValues[index-1] }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <p id="size"></p>
    <p id="text"></p>
    <textarea id="query" v-if="url.length" rows="5">{{ newQuery }} </textarea>
    
    <!-- Extra information  -->
    <md-snackbar md-position="bottom center" ref="snackbar" md-duration="3000">
      <span>{{ notifyMessage }}</span>
      <md-button class="md-accent" md-theme="light-blue" @click.native="$refs.snackbar.close()">Ok</md-button>
    </md-snackbar>
    
    <!-- Alerts and errors -->
    <md-dialog-alert
    :md-content="error.content"
    :md-ok-text="error.button"
    ref="error">
  </md-dialog-alert>
  
  <!-- Open file dialog -->
  <md-dialog
  class="open-dialog"
  md-open-from="#open-button"
  md-close-to="#open-button"
  ref="open-dialog"
  >
  <md-dialog-title>Open input data source</md-dialog-title>
  <md-dialog-content style="min-width: 450px;">
    <md-input-container>
      <label>Local CSV or XML file</label>
      <md-file @change.native="loadFiles($event.target.files)" multiple></md-file>
    </md-input-container>
    <p>or paste a link</p>
    <md-input-container>
      <label>Link to CSV or XML file</label>
      <md-input v-model="url" @blur.native="loadUrl"></md-input>
      <md-icon style="cursor: pointer">link</md-icon>
    </md-input-container>
  </md-dialog-content>
  <md-dialog-actions>
    <md-button class="md-primary" @click.native="closeOpenDialog">Cancel</md-button>
  </md-dialog-actions>
</md-dialog>
</div>
</div>
